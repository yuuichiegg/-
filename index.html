<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±åˆç‰ˆ åœ°éœ‡æƒ…å ±ãƒ“ãƒ¥ãƒ¼ã‚¢ (ç·åˆé˜²ç½AIç‰ˆ) - v6.6</title>
    
    <!-- Leaflet.js CSS and Script -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for a polished look */
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        .leaflet-popup-content { font-size: 14px; line-height: 1.6; }
        .plate-tooltip { background-color: rgba(0, 0, 0, 0.7) !important; border: none !important; box-shadow: none !important; color: white !important; font-weight: bold; font-size: 14px; padding: 4px 8px !important; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal styles with smooth animation */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-container {
            background-color: white; padding: 0; border-radius: 0.5rem;
            width: 90%; max-width: 500px; max-height: 85vh;
            display: flex; flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-overlay.visible .modal-container { transform: scale(1); }
        .modal-header { flex-shrink: 0; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .modal-footer { flex-shrink: 0; text-align: right; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; }
        .modal-container h2 { font-size: 1.5rem; font-weight: bold; }
        .modal-container h3 { font-size: 1.2rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .modal-container p, .modal-container ul { font-size: 0.9rem; line-height: 1.8; margin-bottom: 1rem; }
        .modal-container li { margin-left: 1.5rem; list-style-type: disc; }
        
        /* Floating Toolbox */
        #toolbox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            border-radius: 999px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            gap: 8px;
        }
        .tool-button {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tool-button:hover { background-color: #e5e7eb; transform: translateY(-2px); }
        .tool-button:disabled { cursor: not-allowed; background-color: #e5e7eb; opacity: 0.5; }
        .tool-button svg { width: 24px; height: 24px; }
        
        .map-pin-mode { cursor: crosshair !important; }
        #drone-dashboard {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 500;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            width: 280px;
            border: 1px solid #ccc;
        }
        #drone-dashboard h4 { font-weight: bold; margin-bottom: 8px; }
        #mission-log {
            font-family: monospace;
            font-size: 11px;
            background-color: #2d3748;
            color: #a0aec0;
            padding: 8px;
            border-radius: 4px;
            height: 100px;
            overflow-y: auto;
            margin-top: 8px;
        }
        .drone-icon { transition: all 1s linear; }
        .list-item-hover:hover { background-color: #f0f9ff; }
        .analysis-disclaimer { background-color: #fffbeb; border-left: 4px solid #fbbf24; padding: 1rem; margin-bottom: 1rem; }

        /* Custom Leaflet controls for location */
        .leaflet-bar a.leaflet-control-location,
        .leaflet-bar a.leaflet-control-location:hover,
        .leaflet-bar a.leaflet-control-pindrop,
        .leaflet-bar a.leaflet-control-pindrop:hover {
            background-size: 18px 18px;
            background-position: center;
            background-repeat: no-repeat;
        }
        .leaflet-bar a.leaflet-control-location,
        .leaflet-bar a.leaflet-control-location:hover {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23333"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>');
        }
        .leaflet-bar a.leaflet-control-pindrop,
        .leaflet-bar a.leaflet-control-pindrop:hover {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23333"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>');
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="map-container" class="w-screen h-screen relative">
        <div id="map"></div>
        <!-- Drone Dashboard - Always present, visibility toggled by JS -->
        <div id="drone-dashboard" class="hidden">
            <h4 class="lg:text-lg">ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³çŠ¶æ³</h4>
            <div class="text-sm space-y-1">
                <p>é€Ÿåº¦: <span id="drone-speed">0.0</span> km/h</p>
                <p>é«˜åº¦: <span id="drone-altitude">0.0</span> m</p>
                <p>ãƒãƒƒãƒ†ãƒªãƒ¼: <span id="drone-battery">100.0</span> %</p>
                <p>é¢¨é€Ÿ: <span id="drone-wind-speed">0.0</span> m/s</p>
                <p>éšœå®³ç‰©æ¤œçŸ¥: <span id="drone-obstacle-detection">ãªã—</span></p>
                <p>ETA: <span id="drone-eta">è¨ˆç®—ä¸­...</span></p>
            </div>
            <h5 class="md:text-md font-bold mt-4">ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°</h5>
            <div id="mission-log" class="text-xs"></div>
            <button id="cancel-drone-mission" class="w-full mt-4 bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
    
    <div id="toolbox">
        <button id="mode-toggle-button" class="tool-button" title="ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿"></button>
        <button id="filter-button" class="tool-button" title="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>
        </button>
        <button id="ai-tools-button" class="tool-button" title="AIé˜²ç½ãƒ„ãƒ¼ãƒ«">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM18 15.75l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 18l-1.035.259a3.375 3.375 0 00-2.456 2.456L18 21.75l-.259-1.035a3.375 3.375 0 00-2.456-2.456L14.25 18l1.035-.259a3.375 3.375 0 002.456-2.456L18 15.75z" /></svg>
        </button>
        <button id="info-share-button" class="tool-button" title="æƒ…å ±å…±æœ‰">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </button>
        <button id="drone-request-button" class="tool-button" title="ãƒ‰ãƒ­ãƒ¼ãƒ³æ”¯æ´è¦è«‹">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
        </button>
        <button id="show-drone-narrative-button" class="tool-button hidden" title="ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M18 10.5H6a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25h12a2.25 2.25 0 002.25-2.25v-6.75A2.25 2.25 0 0018 10.5z" />
            </svg>
        </button>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>
    <div id="drone-narrative-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="text-xl font-bold">ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³æƒ…å ±</h2>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button class="modal-close bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>


    <!-- Main application logic -->
    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // --- Constants and Global Variables ---
        const USGS_API_URL = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojson';
        const USGS_DISASTER_API_URL = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson';
        const P2P_API_BASE_URL = 'https://api.p2pquake.net/v2/history?codes=551&limit=';
        const TECTONIC_PLATES_URL = 'https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_plates.json';
        
        let currentMode = 'japan';
        let allEarthquakeData = [];
        let filteredEarthquakeData = [];
        let quakeMarkers = {};
        let isApiCallInProgress = false;
        let userCoords = null;
        let userAddress = null; // Centralized address storage
        let droneAnimationId = null;
        let locationMarker = null; // To keep track of the location marker
        let droneMarkers = []; // To keep track of drone related markers and layers

        // Global variable to store last drone mission data for replay
        let lastDroneMission = null; 
        let lastDroneNarrative = null; // Stores the narrative content for re-opening
        let currentDroneState = { // For smoother real-time data
            speed: 0,
            altitude: 0,
            battery: 100,
            windSpeed: 0,
            obstacleDetected: false,
            targetSpeed: 50, // Target speed in km/h
            targetAltitude: 100, // Target altitude in meters
            targetWindSpeed: 5 // Target wind speed in m/s
        };

        // --- DOM Elements ---
        const modalContainer = document.getElementById('modal-container');
        const droneDashboard = document.getElementById('drone-dashboard');
        const showDroneNarrativeButton = document.getElementById('show-drone-narrative-button');
        const droneNarrativeModalEl = document.getElementById('drone-narrative-modal');


        // --- Leaflet Map Initialization ---
        const map = L.map('map');
        const quakeLayer = L.layerGroup().addTo(map);
        const platesLayer = L.layerGroup();
        const tsunamiLayer = L.layerGroup().addTo(map);
        const notesLayer = L.layerGroup().addTo(map);
        const droneLayer = L.layerGroup().addTo(map); // Dedicated layer for drone elements
        const gsiTile = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>"
        }).addTo(map);
        const baseMaps = { "åœ°ç†é™¢ã‚¿ã‚¤ãƒ«": gsiTile };
        const overlayMaps = { "åœ°éœ‡æƒ…å ±": quakeLayer, "ãƒ—ãƒ¬ãƒ¼ãƒˆ": platesLayer, "æ´¥æ³¢æµ¸æ°´äºˆæ¸¬": tsunamiLayer, "å…±æœ‰æƒ…å ±": notesLayer, "ãƒ‰ãƒ­ãƒ¼ãƒ³": droneLayer };
        L.control.layers(baseMaps, overlayMaps).addTo(map);

        // --- Custom Map Controls ---
        // GPS Location Control
        L.Control.Location = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const button = L.DomUtil.create('a', 'leaflet-control-location', container);
                button.href = '#';
                button.title = 'ç¾åœ¨åœ°ã«ç§»å‹•';
                button.role = 'button';

                L.DomEvent.on(button, 'click', L.DomEvent.stopPropagation)
                            .on(button, 'click', L.DomEvent.preventDefault)
                            .on(button, 'click', () => map.locate({setView: true, maxZoom: 16}));

                return container;
            },
            onRemove: function(map) { /* Nothing to do here */ }
        });
        L.control.location = (opts) => new L.Control.Location(opts);
        L.control.location({ position: 'topleft' }).addTo(map);

        // Pin Drop Control
        L.Control.PinDrop = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const button = L.DomUtil.create('a', 'leaflet-control-pindrop', container);
                button.href = '#';
                button.title = 'åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å ´æ‰€ã‚’æŒ‡å®š';
                button.role = 'button';

                L.DomEvent.on(button, 'click', L.DomEvent.stopPropagation)
                            .on(button, 'click', L.DomEvent.preventDefault)
                            .on(button, 'click', enterPinDropMode);
                return container;
            },
            onRemove: function(map) { /* Nothing to do here */ }
        });
        L.control.pindrop = (opts) => new L.Control.PinDrop(opts);
        L.control.pindrop({ position: 'topleft' }).addTo(map);


        // --- Map Event Listeners for Location ---
        map.on('locationfound', async function(e) {
            if (locationMarker) {
                map.removeLayer(locationMarker);
            }
            const pinIcon = L.divIcon({className: 'text-4xl', html: 'ğŸ”µ'});
            locationMarker = L.marker(e.latlng, {icon: pinIcon, draggable: true}).addTo(map);
            
            locationMarker.on('dragend', function(event) {
                updatePinAddress(event.target);
            });

            await updatePinAddress(locationMarker, `ã‚ãªãŸã®ç¾åœ¨åœ° (èª¤å·® ${Math.round(e.accuracy)} m)`);
            locationMarker.openPopup();
        });
        map.on('locationerror', function(e) {
            showModal('GPSã‚¨ãƒ©ãƒ¼', `<p>GPSæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}</p>`);
        });
        
        // --- Gemini API Call ---
        async function callGeminiApi(prompt) {
            setApiButtonsState(true);
            const apiKey = ""; // Handled by Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) return result.candidates[0].content.parts[0].text;
                else throw new Error('ç„¡åŠ¹ãªAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™ã€‚');
            } catch (error) {
                console.error("Gemini API Error:", error);
                return `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
            } finally { setApiButtonsState(false); }
        }

        // --- AI Feature Functions ---
        async function generateAnalysis() {
            showModal('âœ¨ AIã«ã‚ˆã‚‹åˆ†æã¨è¦‹é€šã—', '<div class="spinner"></div>');
            if (filteredEarthquakeData.length === 0) { 
                updateModalContent('<p>åˆ†æå¯¾è±¡ã®åœ°éœ‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'); return;
            }
            const largestQuake = filteredEarthquakeData.reduce((max, q) => q.earthquake.hypocenter.magnitude > max.earthquake.hypocenter.magnitude ? q : max, filteredEarthquakeData[0]);
            const dataSummary = `æœ€å¤§åœ°éœ‡: M${largestQuake.earthquake.hypocenter.magnitude.toFixed(1)} at ${largestQuake.displayPlace}. åœ°éœ‡ä»¶æ•°: ${filteredEarthquakeData.length}.`;
            const prompt = `ã‚ãªãŸã¯å†·é™ã§ä¿¡é ¼ã§ãã‚‹åœ°éœ‡å­¦è€…ã§ã™ã€‚ä»¥ä¸‹ã®åœ°éœ‡ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ã‚’åŸºã«ã€ä¸€èˆ¬å¸‚æ°‘å‘ã‘ã®ç°¡æ½”ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ãƒ¬ãƒãƒ¼ãƒˆã«ã¯ä»¥ä¸‹ã®è¦ç´ ã‚’å«ã‚ã¦ãã ã•ã„ã€‚1. **æ´»å‹•ã®æ¦‚è¦**: æœ€å¤§åœ°éœ‡ã‚„æ´»ç™ºãªåœ°åŸŸã«ã¤ã„ã¦è¨€åŠã€‚2. **åœ°è³ªå­¦çš„èƒŒæ™¯**: ãƒ—ãƒ¬ãƒ¼ãƒˆã®å‹•ããªã©ã€åœ°éœ‡ã®ç™ºç”Ÿãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’ç°¡å˜ã«è§£èª¬ã€‚3. **ä»Šå¾Œã®è¦‹é€šã—**: ç‰¹å®šã®äºˆæ¸¬ã¯ã›ãšã€ä¸€èˆ¬çš„ãªæ³¨æ„å–šèµ·ï¼ˆä¾‹ï¼šä½™éœ‡ã®å¯èƒ½æ€§ï¼‰ã«ç•™ã‚ã‚‹ã€‚4. **é˜²ç½ã¸ã®å‘¼ã³ã‹ã‘**: ãƒã‚¸ãƒ†ã‚£ãƒ–ã‹ã¤å…·ä½“çš„ã«ã€æ—¥é ƒã®å‚™ãˆã®é‡è¦æ€§ã‚’è¨´ãˆã‚‹ã€‚å…¨ä½“ã‚’Markdownå½¢å¼ã§ã€è¦ªã—ã¿ã‚„ã™ãã€ã‹ã¤æ¨©å¨ã‚’æãªã‚ãªã„ãƒˆãƒ¼ãƒ³ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿æ¦‚è¦: ${dataSummary}`;
            const resultText = await callGeminiApi(prompt);
            updateModalContent(formatTextToHtml(resultText));
        }

        async function generateSafetyReport(location, household) {
            if (!location) { 
                showModal('ã‚¨ãƒ©ãƒ¼', '<p>å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>');
                return;
            }
            showModal('âœ¨ MYé˜²ç½ãƒ¬ãƒãƒ¼ãƒˆ', '<div class="spinner"></div>');
            const dataSummary = `ç¾åœ¨ã®åœ°éœ‡æ´»å‹•ã®æœ€å¤§è¦æ¨¡ã¯M${filteredEarthquakeData.reduce((max, q) => Math.max(max, q.earthquake.hypocenter.magnitude), 0).toFixed(1)}ã§ã™ã€‚`;
            const prompt = `ã‚ãªãŸã¯åœ°åŸŸã®é˜²ç½ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œ${location}ã€ã«ä½ã‚“ã§ãŠã‚Šã€ä¸–å¸¯æ§‹æˆã¯ã€Œ${household}ã€ã§ã™ã€‚ç¾åœ¨ã®åœ°éœ‡æ´»å‹•ï¼ˆ${dataSummary}ï¼‰ã‚’è¸ã¾ãˆã€ãã®åœ°åŸŸã¨ä¸–å¸¯æ§‹æˆã«ç‰¹åŒ–ã—ãŸãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãªé˜²ç½ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ãƒ¬ãƒãƒ¼ãƒˆã«ã¯ä»¥ä¸‹ã®è¦ç´ ã‚’å«ã‚ã¦ãã ã•ã„ã€‚1. **åœ°åŸŸç‰¹æ€§ã®è€ƒæ…®**: ${location}ã®åœ°ç†çš„ç‰¹å¾´ï¼ˆä¾‹ï¼šæ²¿å²¸éƒ¨ã€éƒ½å¸‚éƒ¨ã€å±±é–“éƒ¨ãªã©ï¼‰ã‚’è€ƒæ…®ã—ãŸå…·ä½“çš„ãªãƒªã‚¹ã‚¯ã«ã¤ã„ã¦è¨€åŠã€‚2. **ä¸–å¸¯æ§‹æˆã«åˆã‚ã›ãŸå‚™ãˆ**: ã€Œ${household}ã€ã«ç‰¹ã«é‡è¦ãªã€å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆã€‚3. **å‚™è“„å“ãƒªã‚¹ãƒˆ**: ä¸–å¸¯æ§‹æˆã«åˆã‚ã›ãŸéå¸¸ç”¨æŒã¡å‡ºã—è¢‹ã®ä¸­èº«ã‚’ãƒªã‚¹ãƒˆå½¢å¼ã§ææ¡ˆã€‚4. **ç‰©è³‡ç¢ºä¿ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹**: ç½å®³æ™‚ã«æ°´ã€é£Ÿæ–™ã€ãƒãƒƒãƒ†ãƒªãƒ¼ãªã©ã®ç‰©è³‡ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚5. **å¿ƒã®ã‚±ã‚¢**: ä¸å®‰ã‚’ç…½ã‚‰ãšã€å‚™ãˆã‚‹ã“ã¨ã®é‡è¦æ€§ã‚’ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ä¼ãˆã‚‹ã€‚å…¨ä½“ã‚’Markdownå½¢å¼ã§ã€è¦ªã—ã¿ã‚„ã™ãã€å…·ä½“çš„ã§å½¹ç«‹ã¤å†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚`;
            const resultText = await callGeminiApi(prompt);
            updateModalContent(formatTextToHtml(resultText));
        }
        
        async function generatePreparednessTips() {
            showModal('ğŸ’¡ äº‹å‰ã®å‚™ãˆ (AIé˜²ç½ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼)', '<div class="spinner"></div>');
            const prompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªé˜²ç½ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚åœ°éœ‡ãŒç™ºç”Ÿã™ã‚‹å‰ã«å®¶åº­ã§ã§ãã‚‹äºˆé˜²ç­–ã‚„ã€é˜²ç½è¨ˆç”»ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã„ãã¤ã‹ææ¡ˆã—ã¦ãã ã•ã„ã€‚å®¶å…·ã®å›ºå®šæ–¹æ³•ã€å‚™è“„å“ã®é¸ã³æ–¹ã€å®¶æ—ã¨ã®é€£çµ¡æ–¹æ³•ã®ç¢ºèªãªã©ã€èª­è€…ãŒã™ãã«è¡Œå‹•ã«ç§»ã›ã‚‹ã‚ˆã†ãªå…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’Markdownå½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;
            const resultText = await callGeminiApi(prompt);
            updateModalContent(formatTextToHtml(resultText));
        }
        
        async function generatePowerOutageReport() {
            const locationInput = document.getElementById('location-input');
            if (!locationInput || !locationInput.value) {
                showModal('ã‚¨ãƒ©ãƒ¼', '<p>åœé›»ãƒªã‚¹ã‚¯åˆ†æã«ã¯ã€ã¾ãšã€ŒMYé˜²ç½ãƒ¬ãƒãƒ¼ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>');
                return;
            }
            showModal('ğŸ’¡ åœé›»ãƒªã‚¹ã‚¯åˆ†æ (AI)', '<div class="spinner"></div>');
            const largestQuake = filteredEarthquakeData.length > 0 ? filteredEarthquakeData.reduce((max, q) => q.earthquake.hypocenter.magnitude > max.earthquake.hypocenter.magnitude ? q : max, filteredEarthquakeData[0]) : null;
            const prompt = `ã‚ãªãŸã¯é›»åŠ›ã‚¤ãƒ³ãƒ•ãƒ©ã«è©³ã—ã„é˜²ç½å°‚é–€å®¶ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œ${locationInput.value}ã€ã«ã„ã¾ã™ã€‚ç¾åœ¨ã€æœ€å¤§M${largestQuake ? largestQuake.earthquake.hypocenter.magnitude.toFixed(1) : 'ä¸æ˜'}ã®åœ°éœ‡ãŒè¦³æ¸¬ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®çŠ¶æ³ã‚’è¸ã¾ãˆã€ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚
            1. **åœé›»ã®å¯èƒ½æ€§**: ã“ã®è¦æ¨¡ã®åœ°éœ‡ã§ã€${locationInput.value}ã§åœé›»ãŒç™ºç”Ÿã™ã‚‹ä¸€èˆ¬çš„ãªå¯èƒ½æ€§ã¯ï¼Ÿ
            2. **å¾©æ—§ã®è¦‹é€šã—**: ã‚‚ã—åœé›»ã—ãŸå ´åˆã€å¾©æ—§ã«ã¯ã©ã®ãã‚‰ã„ã®æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ï¼Ÿ
            3. **ä»Šã™ãã§ãã‚‹å¯¾ç­–**: åœé›»ã«å‚™ãˆã¦ã€ä»Šã™ãã§ãã‚‹ã“ã¨ã¯ä½•ã‹ï¼Ÿ(ä¾‹: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®å……é›»ã€æ‡ä¸­é›»ç¯ã®æº–å‚™ãªã©)
            å°‚é–€çš„ã‹ã¤åˆ†ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã§ã€Markdownå½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;
            const resultText = await callGeminiApi(prompt);
            updateModalContent(formatTextToHtml(resultText));
        }
        
        async function generateDroneFutureReport() {
            showModal('ğŸ¤– AIã¨èªã‚‹ãƒ‰ãƒ­ãƒ¼ãƒ³ã®æœªæ¥', '<div class="spinner"></div>');
            const prompt = `ã‚ãªãŸã¯ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã¨ç¤¾ä¼šã®æœªæ¥ã«è©³ã—ã„ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚ã€Œç½å®³å¯¾ç­–ã«ãŠã‘ã‚‹ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é‡è¦æ€§ã¨ä»Šå¾Œã®å±•æœ›ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã§ã€ä¸€èˆ¬å‘ã‘ã®è§£èª¬è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®è¦ç´ ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
            1. **ç¾åœ¨ã®æ´»ç”¨äº‹ä¾‹**: ç‰©è³‡è¼¸é€ã€æƒ…å ±åé›†ã€è¢«ç½è€…æœç´¢ãªã©ã€‚
            2. **æœªæ¥ã®å¯èƒ½æ€§**: 1å¯¾né‹èˆªï¼ˆç¾¤åˆ¶å¾¡ï¼‰ã€AIã«ã‚ˆã‚‹è‡ªå¾‹åˆ¤æ–­ã€æ•‘åŠ©æ´»å‹•ã¸ã®ç›´æ¥å‚åŠ ãªã©ã€ã•ã‚‰ã«é€²ã‚“ã æ´»ç”¨æ–¹æ³•ã€‚
            3. **è§£æ±ºã™ã¹ãèª²é¡Œ**: æ³•æ•´å‚™ã€æ©Ÿä½“æ€§èƒ½ã®å‘ä¸Šï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼ã€ç©è¼‰é‡ï¼‰ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã€ç¤¾ä¼šçš„ãªå—å®¹æ€§ãªã©ã€‚
            èª­è€…ãŒæœªæ¥ã«å¸Œæœ›ã‚’æŒã¦ã‚‹ã‚ˆã†ãªã€å‰å‘ããªãƒˆãƒ¼ãƒ³ã§Markdownå½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;
            const resultText = await callGeminiApi(prompt);
            updateModalContent(formatTextToHtml(resultText));
        }

        async function generateTransitAdvice() {
            showModal('ğŸš— äº¤é€šæ©Ÿé–¢å‘ã‘AIã‚¢ãƒ‰ãƒã‚¤ã‚¹', '<div class="spinner"></div>');
            const prompt = `ã‚ãªãŸã¯ç½å®³å±æ©Ÿç®¡ç†ã®å°‚é–€å®¶ã§ã™ã€‚åœ°éœ‡ç™ºç”Ÿæ™‚ã«ã€æ§˜ã€…ãªäº¤é€šæ©Ÿé–¢ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹äººã€…ï¼ˆé‹è»¢æ‰‹ã‚„ä¹—å®¢ï¼‰ã«å‘ã‘ã¦ã€ãã‚Œãã‚Œã®çŠ¶æ³ã«å¿œã˜ãŸå…·ä½“çš„ã§å®‰å…¨ãªè¡Œå‹•æŒ‡é‡ã‚’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®é …ç›®ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
            - **è‡ªå‹•è»Šã‚’é‹è»¢ä¸­ã®å ´åˆ**
            - **ãƒã‚¹ã‚„ã‚¿ã‚¯ã‚·ãƒ¼ã«ä¹—è»Šä¸­ã®å ´åˆ**
            - **é‰„é“ï¼ˆé›»è»Šãƒ»æ–°å¹¹ç·šï¼‰ã«ä¹—è»Šä¸­ã®å ´åˆ**
            - **ãƒã‚¤ã‚¯ã‚„è‡ªè»¢è»Šã«ä¹—ã£ã¦ã„ã‚‹å ´åˆ**
            å„é …ç›®ã§ã€ã€Œæºã‚Œã¦ã„ã‚‹æœ€ä¸­ã®è¡Œå‹•ã€ã¨ã€Œæºã‚ŒãŒåã¾ã£ãŸå¾Œã®è¡Œå‹•ã€ã‚’æ˜ç¢ºã«åˆ†ã‘ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚Markdownå½¢å¼ã§ã€ç°¡æ½”ã‹ã¤åˆ†ã‹ã‚Šã‚„ã™ãè¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;
            const resultText = await callGeminiApi(prompt);
            updateModalContent(formatTextToHtml(resultText));
        }

        async function getHistoricalContext(quake) {
            showModal('âœ¨ AIã«ã‚ˆã‚‹åœ°åŸŸã®åœ°éœ‡å±¥æ­´åˆ†æ', '<div class="spinner"></div>');
            const prompt = `ã‚ãªãŸã¯åœ°éœ‡ã®æ­´å²ã«è©³ã—ã„å°‚é–€å®¶ã§ã™ã€‚ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰${quake.earthquake.hypocenter.magnitude.toFixed(1)}ã®åœ°éœ‡ãŒã€Œ${quake.displayPlace}ã€ã§ç™ºç”Ÿã—ã¾ã—ãŸã€‚ã“ã®åœ°åŸŸã«ãŠã‘ã‚‹éå»ã®ç‰¹ç­†ã™ã¹ãåœ°éœ‡æ´»å‹•ã‚„ã€ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ†ã‚¯ãƒˆãƒ‹ã‚¯ã‚¹ã®è¦³ç‚¹ã‹ã‚‰ã®åœ°è³ªå­¦çš„ãªèƒŒæ™¯ã«ã¤ã„ã¦ã€ä¸€èˆ¬ã®äººã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚ã“ã®åœ°åŸŸã¯åœ°éœ‡ãŒå¤šã„ã“ã¨ã§çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã‚‚ã—ã‚ãªãŸã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã«è‘—åãªéå»ã®åœ°éœ‡ãŒã‚ã‚Œã°ã€ãã‚Œã«è¨€åŠã—ã¦ãã ã•ã„ã€‚`;
            const resultText = await callGeminiApi(prompt);
            updateModalContent(formatTextToHtml(resultText));
        }

        // --- Core Feature Functions ---
        async function handleDroneRequest() {
            const modalId = `modal-drone-request-${Date.now()}`;
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <p class="text-sm mb-2">æ”¯æ´ç‰©è³‡ã‚’å—ã‘å–ã‚ŠãŸã„å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>
                        <div class="space-y-2">
                            <input type="text" id="drone-location-input" placeholder="å ´æ‰€ã‚’å…¥åŠ› or åœ°å›³ã§æŒ‡å®š" class="w-full p-2 border rounded-md">
                            <div class="flex gap-2">
                                <button id="drone-map-select-button" class="flex-1 bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300 text-sm">åœ°å›³ã‹ã‚‰é¸æŠ</button>
                                <button id="drone-gps-button" class="flex-1 bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300 text-sm">ç¾åœ¨åœ°ã‚’å–å¾—</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <p>å¿…è¦ãªç‰©è³‡ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰ï¼š</p>
                        <div class="space-y-2 my-4">
                            <label class="flex items-center"><input type="checkbox" name="drone-supplies" value="åŒ»è–¬å“" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"> <span class="ml-2">åŒ»è–¬å“ (å¿œæ€¥æ‰‹å½“ã‚»ãƒƒãƒˆãªã©)</span></label>
                            <label class="flex items-center"><input type="checkbox" name="drone-supplies" value="é£Ÿæ–™ãƒ»æ°´" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"> <span class="ml-2">é£Ÿæ–™ãƒ»æ°´ (æœ€ä½1æ—¥åˆ†)</span></label>
                            <label class="flex items-center"><input type="checkbox" name="drone-supplies" value="ãƒãƒƒãƒ†ãƒªãƒ¼" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"> <span class="ml-2">ãƒãƒƒãƒ†ãƒªãƒ¼ (ãƒ¢ãƒã‚¤ãƒ«ç”¨)</span></label>
                        </div>
                    </div>
                    <div class="text-right">
                        <button id="submit-drone-request" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-md hover:bg-sky-700">AIã«ã‚ˆã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</button>
                    </div>
                </div>
            `;
            const modalEl = showModal('ğŸš ãƒ‰ãƒ­ãƒ¼ãƒ³æ”¯æ´è¦è«‹ (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)', modalContent, modalId);
            
            const locationInput = modalEl.querySelector('#drone-location-input');
            if (userAddress) {
                locationInput.value = userAddress;
            }

            modalEl.querySelector('#drone-map-select-button').addEventListener('click', () => enterPinMode('drone-location-input'));
            modalEl.querySelector('#drone-gps-button').addEventListener('click', () => getCurrentLocation('drone-location-input'));

            modalEl.querySelector('#submit-drone-request').addEventListener('click', async () => {
                const selectedSupplies = Array.from(modalEl.querySelectorAll('input[name="drone-supplies"]:checked')).map(cb => cb.value);
                
                if (!locationInput.value) {
                    updateModalContent('<p class="text-red-500">å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>', modalEl); return;
                }
                if (selectedSupplies.length === 0) {
                    updateModalContent('<p class="text-red-500">å°‘ãªãã¨ã‚‚1ã¤ã®ç‰©è³‡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>', modalEl); return;
                }

                // Close the input modal
                modalEl.querySelector('.modal-close').click();

                // Show a temporary loading message or notification
                showModal('ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹', '<div class="spinner"></div><p class="text-center mt-4">ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æº–å‚™ä¸­ã§ã™...</p>', 'drone-loading-modal');

                const prompt = `ã‚ãªãŸã¯ç½å®³å¯¾å¿œãƒ‰ãƒ­ãƒ¼ãƒ³ã®é‹ç”¨AIã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä»¥ä¸‹ã®å†…å®¹ã§æ”¯æ´è¦è«‹ãŒã‚ã‚Šã¾ã—ãŸã€‚å¿œç­”ã‚’\`\`\`json ... \`\`\` ã®ã‚ˆã†ã«Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸è¦ã§ã™ã€‚
                - **è¦è«‹å ´æ‰€**: ${locationInput.value}
                - **è¦è«‹å ´æ‰€ã®åº§æ¨™**: ${userCoords ? `ç·¯åº¦${userCoords.lat}, çµŒåº¦${userCoords.lng}`: 'ä¸æ˜'}
                - **è¦è«‹ç‰©è³‡**: ${selectedSupplies.join(', ')}
                - **ç¾åœ¨ã®çŠ¶æ³**: å¤§è¦æ¨¡ãªåœ°éœ‡ãŒç™ºç”Ÿã—ã€äº¤é€šç¶²ã«å½±éŸ¿ãŒå‡ºã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

                å¿œç­”JSONã®ä»•æ§˜:
                {
                  "departurePointName": "ï¼ˆ${locationInput.value} å†…ã®å…·ä½“çš„ãªå‡ºç™ºæ‹ ç‚¹åã€‚å¸‚å½¹æ‰€ã€å¤§ããªå…¬åœ’ãªã©ï¼‰",
                  "departurePointLat": ï¼ˆå‡ºç™ºåœ°ç‚¹ã®ç·¯åº¦ï¼‰,
                  "departurePointLng": ï¼ˆå‡ºç™ºåœ°ç‚¹ã®çµŒåº¦ï¼‰,
                  "estimatedFlightMinutes": ï¼ˆç¾å®Ÿçš„ãªé£›è¡Œæ™‚é–“ï¼ˆåˆ†ï¼‰ï¼‰,
                  "missionLog": [
                        {"time": 0, "event": "è¦è«‹ã‚’å—ç†ã—ã¾ã—ãŸã€‚ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚’ç™ºé€²æº–å‚™ä¸­ã§ã™ã€‚"},
                        {"time": 1, "event": "ãƒ‰ãƒ­ãƒ¼ãƒ³ãŒæ‹ ç‚¹ï¼ˆ${locationInput.value}é˜²ç½ã‚»ãƒ³ã‚¿ãƒ¼ï¼‰ã‹ã‚‰é›¢é™¸ã—ã¾ã—ãŸã€‚"},
                        {"time": 5, "event": "é«˜åº¦100mã€é€Ÿåº¦50km/hã§å®‰å®šé£›è¡Œä¸­ã€‚"},
                        {"time": 8, "event": "ä»–ã®ç·Šæ€¥è»Šä¸¡ã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã€ä¸€æ™‚çš„ã«ãƒ«ãƒ¼ãƒˆã‚’èª¿æ•´ã—ã¾ã™ã€‚"},
                        {"time": 12, "event": "ç›®çš„åœ°ã¾ã§ã‚ã¨ã‚ãšã‹ã§ã™ã€‚å®‰å…¨ãªå ´æ‰€ã§å¾…æ©Ÿã—ã¦ãã ã•ã„ã€‚"}
                  ],
                  "narrative": "ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚è¦è«‹å—ç†ã€ç™ºé€²ã€åˆ°ç€äºˆå®šã€é£›è¡ŒçµŒè·¯ã€å—ã‘å–ã‚Šæ™‚ã®æ³¨æ„ã€å…è²¬äº‹é …ã‚’å«ã‚€Markdownå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰"
                }`;
                const resultText = await callGeminiApi(prompt);
                
                // Close loading modal
                document.getElementById('drone-loading-modal')?.remove();

                try {
                    const jsonMatch = resultText.match(/```json\n([\s\S]*?)\n```/);
                    if (!jsonMatch || !jsonMatch[1]) throw new Error("AIã®å¿œç­”ã«JSONãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    const jsonString = jsonMatch[1];
                    const resultJson = JSON.parse(jsonString);
                    
                    // Store narrative for re-opening
                    lastDroneNarrative = formatTextToHtml(resultJson.narrative);
                    showDroneNarrativeButton.classList.remove('hidden'); // Show the button


                    // Show narrative in the dedicated modal
                    showDroneNarrativeModal();

                    if(userCoords) {
                        const startPoint = [resultJson.departurePointLat, resultJson.departurePointLng];
                        const endPoint = [userCoords.lat, userCoords.lng];
                        // Store mission data for replay (for static display)
                        lastDroneMission = {
                            start: startPoint,
                            end: endPoint,
                            durationMinutes: resultJson.estimatedFlightMinutes,
                            missionLog: resultJson.missionLog
                        };
                        // Initialize drone animation on the main map
                        initializeDroneMap(map, startPoint, endPoint, resultJson.estimatedFlightMinutes, resultJson.missionLog);
                    }
                } catch(e) {
                    console.error("Failed to parse drone response JSON", e);
                    showModal('ã‚¨ãƒ©ãƒ¼', `<p class="text-red-500">AIã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã§è¡¨ç¤ºã—ã¾ã™ã€‚</p>${formatTextToHtml(resultText)}`);
                }
            });
        }
        
        function handleTsunamiSimulation(quake) {
            if (!quake.earthquake.tsunami) {
                showModal('æ´¥æ³¢æƒ…å ±', '<p>ã“ã®åœ°éœ‡ã«ã‚ˆã‚‹æ´¥æ³¢ã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>');
                return;
            }
            if (!userCoords) {
                showModal('ã‚¨ãƒ©ãƒ¼', '<p>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ã€ã¾ãšã€ŒMYé˜²ç½ãƒ¬ãƒãƒ¼ãƒˆã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ãªãŸã®å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>');
                return;
            }

            tsunamiLayer.clearLayers();
            
            // Simulate inundation zone
            const center = [quake.earthquake.hypocenter.latitude, quake.earthquake.hypocenter.longitude];
            const radius = 10000 + quake.earthquake.hypocenter.magnitude * 2000; // Simplified radius
            const circle = L.circle(center, {
                color: 'blue', fillColor: '#3388ff', fillOpacity: 0.3, radius: radius
            }).addTo(tsunamiLayer);

            // Simulate evacuation route
            const userLatLng = L.latLng(userCoords.lat, userCoords.lng);
            const bearing = map.project(center).subtract(map.project(userLatLng)).angle();
            const evacuationPoint = L.latLng(
                userLatLng.lat + Math.sin(bearing) * 0.05, // Approx 5km away
                userLatLng.lng + Math.cos(bearing) * 0.05
            );
            
            const route = L.polyline([userLatLng, evacuationPoint], {color: 'green', dashArray: '5, 5'}).addTo(tsunamiLayer);
            const shelterIcon = L.divIcon({className: 'text-4xl', html: 'ğŸ«'});
            L.marker(evacuationPoint, {icon: shelterIcon}).addTo(tsunamiLayer).bindTooltip("é«˜å°é¿é›£å ´æ‰€ (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)");

            map.fitBounds(L.featureGroup([circle, route]).getBounds().pad(0.2));
            
            showModal('æ´¥æ³¢ãƒ»é¿é›£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', '<div class="analysis-disclaimer"><strong>ã€é‡è¦ã€‘</strong>ã“ã‚Œã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿéš›ã®æµ¸æ°´åŸŸã‚„é¿é›£çµŒè·¯ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚å®Ÿéš›ã®é¿é›£ã¯ã€å¿…ãšè‡ªæ²»ä½“ã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„ã€‚</div><p>åœ°å›³ä¸Šã«é’ã§æƒ³å®šæµ¸æ°´åŸŸã€ç·‘ã®ç ´ç·šã§é«˜å°ã¸ã®é¿é›£ãƒ«ãƒ¼ãƒˆï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚</p>');
        }

        function switchMode(newMode) {
            if (currentMode === newMode && allEarthquakeData.length > 0) return;
            currentMode = newMode;
            if (locationMarker) {
                map.removeLayer(locationMarker);
                locationMarker = null;
            }
            map.setView(newMode === 'world' ? [20, 0] : [36, 138], newMode === 'world' ? 2 : 5);
            updateModeToggleButton();
            setTimeout(() => map.invalidateSize(), 0);
            allEarthquakeData = [];
            filteredEarthquakeData = [];
            fetchData();
        }

        function fetchData() {
            if (currentMode === 'world') {
                fetchWorldData();
            } else {
                fetchJapanData();
            }
        }

        function applyFilters() {
            const magFilter = document.getElementById('mag-filter');
            const minMag = magFilter ? parseFloat(magFilter.value) : 0;
            
            filteredEarthquakeData = allEarthquakeData.filter(quake => quake.earthquake.hypocenter.magnitude >= minMag);
            
            if (currentMode === 'world') {
                const regionFilter = document.getElementById('region-filter');
                const selectedRegion = regionFilter ? regionFilter.value : 'all';
                if (selectedRegion !== 'all') {
                    filteredEarthquakeData = filteredEarthquakeData.filter(quake => quake.region === selectedRegion);
                }
            }
            renderEarthquakes(filteredEarthquakeData);
        }

        function renderEarthquakes(data) {
            const listElement = document.getElementById('earthquake-list');
            const quakeCount = document.getElementById('quake-count');
            
            quakeLayer.clearLayers();
            quakeMarkers = {};

            if (listElement) listElement.innerHTML = '';
            if (quakeCount) quakeCount.textContent = data.length;

            if (!data || data.length === 0) {
                if(listElement) listElement.innerHTML = '<li class="p-4 text-center text-gray-500">è¡¨ç¤ºã§ãã‚‹åœ°éœ‡æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; 
                return;
            }
            
            data.sort((a, b) => b.time - a.time);
            
            data.forEach(quake => {
                const { hypocenter, tsunami, shindo } = quake.earthquake;
                const { latitude, longitude, magnitude, depth } = hypocenter;
                const { displayPlace, displayTime } = quake;
                const quakeId = quake.id;
                const radius = Math.pow(1.8, magnitude) * (currentMode === 'world' ? 3000 : 500);
                const fillColor = currentMode === 'world' ? getMagnitudeColor(magnitude) : getJmaShindoColor(shindo.value);
                const defaultStyle = { color: "#111", weight: 1, fillColor: fillColor, fillOpacity: 0.7, radius: radius };
                const highlightStyle = { color: "#000000", weight: 4 };
                const circle = L.circle([latitude, longitude], defaultStyle);
                const shindoLabel = shindo.type === 'JMA' ? 'æ°—è±¡åºéœ‡åº¦' : 'MMIéœ‡åº¦';
                const shindoValue = shindo.value || 'æƒ…å ±ãªã—';
                
                const popupContent = document.createElement('div');
                popupContent.className = 'font-sans space-y-2';
                popupContent.innerHTML = `<strong class="text-base">ç™ºç”Ÿæ™‚åˆ»:</strong> ${displayTime}<br><strong class="text-base">éœ‡æºåœ°:</strong> ${displayPlace}<br><strong class="text-base">ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰:</strong> ${magnitude.toFixed(1)}<br><strong class="text-base">æ·±ã•:</strong> ${depth.toFixed(1)} km<br><strong class="text-base">${shindoLabel}:</strong> ${shindoValue}<br><strong class="text-base">æ´¥æ³¢ã®å¯èƒ½æ€§:</strong> ${tsunami ? 'ã‚ã‚Š' : 'ãªã—'}`;
                
                const historyButton = document.createElement('button');
                historyButton.className = 'w-full mt-2 text-sm bg-purple-600 text-white font-bold py-1 px-2 rounded-md hover:bg-purple-700 transition-colors';
                historyButton.innerHTML = 'âœ¨ ã“ã®åœ°åŸŸã®éå»ã®æ´»å‹•ã‚’AIåˆ†æ';
                historyButton.onclick = () => getHistoricalContext(quake);
                
                const tsunamiButton = document.createElement('button');
                tsunamiButton.className = 'w-full mt-1 text-sm bg-cyan-600 text-white font-bold py-1 px-2 rounded-md hover:bg-cyan-700 transition-colors';
                tsunamiButton.innerHTML = 'ğŸŒŠ æ´¥æ³¢ãƒ»é¿é›£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³';
                tsunamiButton.onclick = () => handleTsunamiSimulation(quake);

                popupContent.appendChild(historyButton);
                popupContent.appendChild(tsunamiButton);
                circle.bindPopup(popupContent);

                quakeLayer.addLayer(circle);
                
                if (listElement) {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-3 border rounded-lg shadow-sm list-item-hover transition-colors duration-200 cursor-pointer';
                    listItem.innerHTML = `<div class="font-semibold text-gray-800">${displayPlace} ${tsunami ? 'ğŸŒŠ' : ''}</div><div class="text-sm text-gray-600">${displayTime}</div><div class="flex flex-wrap justify-between items-center mt-2 text-sm gap-x-4 gap-y-1"><span class="font-bold px-2 py-1 rounded-md" style="background-color:${fillColor}; color: ${isDarkColor(fillColor) ? 'white' : 'black'}">ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ ${magnitude.toFixed(1)}</span><span>æ·±ã•: ${depth.toFixed(1)} km</span><span>${shindoLabel}: ${shindoValue}</span></div>`;
                    listItem.addEventListener('mouseover', () => { circle.setStyle(highlightStyle).bringToFront(); });
                    listItem.addEventListener('mouseout', () => { circle.setStyle(defaultStyle); });
                    listItem.addEventListener('click', () => { map.flyTo([latitude, longitude], 6); circle.openPopup(); });
                    listElement.appendChild(listItem);
                }
                quakeMarkers[quakeId] = { circle };
            });
        }
        
        async function fetchTectonicPlates() {
            const plateNameMap = { "African": "ã‚¢ãƒ•ãƒªã‚«ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Antarctic": "å—æ¥µãƒ—ãƒ¬ãƒ¼ãƒˆ", "Arabian": "ã‚¢ãƒ©ãƒ“ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Australian": "ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Caribbean": "ã‚«ãƒªãƒ–ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Cocos": "ã‚³ã‚³ã‚¹ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Eurasian": "ãƒ¦ãƒ¼ãƒ©ã‚·ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Indian": "ã‚¤ãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Juan de Fuca": "ãƒ•ã‚¡ãƒ³ãƒ‡ãƒ•ã‚«ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Nazca": "ãƒŠã‚¹ã‚«ãƒ—ãƒ¬ãƒ¼ãƒˆ", "North American": "åŒ—ç±³ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Okhotsk": "ã‚ªãƒ›ãƒ¼ãƒ„ã‚¯ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Pacific": "å¤ªå¹³æ´‹ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Philippine Sea": "ãƒ•ã‚£ãƒªãƒ”ãƒ³æµ·ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Scotia": "ã‚¹ã‚³ã‚·ã‚¢ãƒ—ãƒ¬ãƒ¼ãƒˆ", "South American": "å—ç±³ãƒ—ãƒ¬ãƒ¼ãƒˆ" };
            try {
                const response = await fetch(TECTONIC_PLATES_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const platesData = await response.json();
                L.geoJSON(platesData, { style: { color: "#ff7800", weight: 2, opacity: 0.65, fillColor: "#ff7800", fillOpacity: 0.1 }, onEachFeature: (feature, layer) => { if (feature.properties && feature.properties.PlateName) { const displayName = plateNameMap[feature.properties.PlateName] || feature.properties.PlateName; layer.bindTooltip(displayName, { permanent: false, direction: 'center', className: 'plate-tooltip' }); } } }).addTo(platesLayer);
            } catch (error) { console.error('Failed to fetch tectonic plates data:', error); }
        }

        async function fetchWorldData(isDisaster = false) {
            const url = isDisaster ? USGS_DISASTER_API_URL : USGS_API_URL;
            const countryNameMap = { "CA": "ã‚«ãƒªãƒ•ã‚©ãƒ«ãƒ‹ã‚¢", "California": "ã‚«ãƒªãƒ•ã‚©ãƒ«ãƒ‹ã‚¢", "Alaska": "ã‚¢ãƒ©ã‚¹ã‚«", "Hawaii": "ãƒãƒ¯ã‚¤", "Indonesia": "ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢", "Japan": "æ—¥æœ¬", "Philippines": "ãƒ•ã‚£ãƒªãƒ”ãƒ³", "Fiji": "ãƒ•ã‚£ã‚¸ãƒ¼", "Chile": "ãƒãƒª", "Mexico": "ãƒ¡ã‚­ã‚·ã‚³", "New Zealand": "ãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰", "Russia": "ãƒ­ã‚·ã‚¢", "Papua New Guinea": "ãƒ‘ãƒ—ã‚¢ãƒ‹ãƒ¥ãƒ¼ã‚®ãƒ‹ã‚¢", "Tonga": "ãƒˆãƒ³ã‚¬", "Vanuatu": "ãƒãƒŒã‚¢ãƒ„", "Solomon Islands": "ã‚½ãƒ­ãƒ¢ãƒ³è«¸å³¶", "Taiwan": "å°æ¹¾", "China": "ä¸­å›½", "Turkey": "ãƒˆãƒ«ã‚³", "Greece": "ã‚®ãƒªã‚·ãƒ£", "Italy": "ã‚¤ã‚¿ãƒªã‚¢", "Iran": "ã‚¤ãƒ©ãƒ³", "Peru": "ãƒšãƒ«ãƒ¼", "Argentina": "ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", "Colombia": "ã‚³ãƒ­ãƒ³ãƒ“ã‚¢", "Ecuador": "ã‚¨ã‚¯ã‚¢ãƒ‰ãƒ«", "Guatemala": "ã‚°ã‚¢ãƒ†ãƒãƒ©", "Costa Rica": "ã‚³ã‚¹ã‚¿ãƒªã‚«", "Nicaragua": "ãƒ‹ã‚«ãƒ©ã‚°ã‚¢", "El Salvador": "ã‚¨ãƒ«ã‚µãƒ«ãƒãƒ‰ãƒ«", "Honduras": "ãƒ›ãƒ³ã‚¸ãƒ¥ãƒ©ã‚¹", "Panama": "ãƒ‘ãƒŠãƒ", "Puerto Rico": "ãƒ—ã‚¨ãƒ«ãƒˆãƒªã‚³", "Dominican Republic": "ãƒ‰ãƒŸãƒ‹ã‚«å…±å’Œå›½", "Iceland": "ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰", "Portugal": "ãƒãƒ«ãƒˆã‚¬ãƒ«", "Spain": "ã‚¹ãƒšã‚¤ãƒ³", "India": "ã‚¤ãƒ³ãƒ‰", "Pakistan": "ãƒ‘ã‚­ã‚¹ã‚¿ãƒ³", "Afghanistan": "ã‚¢ãƒ•ã‚¬ãƒ‹ã‚¹ã‚¿ãƒ³", "Kyrgyzstan": "ã‚­ãƒ«ã‚®ã‚¹", "Tajikistan": "ã‚¿ã‚¸ã‚­ã‚¹ã‚¿ãƒ³", "Uzbekistan": "ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³" };
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const regions = new Set();
                allEarthquakeData = data.features.map(feature => {
                    const place = feature.properties.place; const latitude = feature.geometry.coordinates[1]; const longitude = feature.geometry.coordinates[0];
                    let region = place, japanesePlace = place, isJapan = false;
                    if (place && place.includes(',')) { const parts = place.split(','); region = parts[parts.length - 1].trim(); if (region === "Japan") isJapan = true; const translatedRegion = countryNameMap[region] || region; japanesePlace = `${translatedRegion} - ${parts.slice(0, -1).join(',')}`; } else if (place && place.toLowerCase().includes("japan")) { isJapan = true; region = "Japan"; japanesePlace = place; }
                    regions.add(region);
                    const isNearJapan = latitude >= 20 && latitude <= 46 && longitude >= 122 && longitude <= 154;
                    const displayTime = isNearJapan ? new Date(feature.properties.time).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' (æ—¥æœ¬æ™‚é–“)' : new Date(feature.properties.time).toLocaleString('ja-JP', { timeZone: 'UTC' }) + ' (å”å®šä¸–ç•Œæ™‚)';
                    return { id: feature.id, time: feature.properties.time, region: region, displayPlace: japanesePlace, isJapan: isJapan, displayTime: displayTime, earthquake: { hypocenter: { latitude: latitude, longitude: longitude, depth: feature.geometry.coordinates[2], magnitude: feature.properties.mag }, tsunami: feature.properties.tsunami, shindo: { type: isJapan ? 'JMA' : 'MMI', value: isJapan ? convertMmiToJmaShindo(feature.properties.mmi) : convertMmiToRoman(feature.properties.mmi) } } };
                });
                populateRegionFilter(regions); applyFilters();
            } catch (error) { console.error('Failed to fetch world data:', error); }
        }
        
        async function fetchJapanData(limit = 100) {
            try {
                const response = await fetch(P2P_API_BASE_URL + limit);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                allEarthquakeData = data.map(q => {
                    const { earthquake, id, time } = q;
                    return { id: id, time: new Date(time).getTime(), region: 'Japan', displayPlace: earthquake.hypocenter.name, isJapan: true, displayTime: new Date(time).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' (æ—¥æœ¬æ™‚é–“)', earthquake: { hypocenter: { latitude: parseFloat(earthquake.hypocenter.latitude), longitude: parseFloat(earthquake.hypocenter.longitude), depth: parseFloat(earthquake.hypocenter.depth), magnitude: parseFloat(earthquake.hypocenter.magnitude) }, tsunami: earthquake.tsunami?.text.includes('æ´¥æ³¢ã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“') === false, shindo: { type: 'JMA', value: convertScale(earthquake.maxScale) } } };
                });
                applyFilters();
            } catch(error) { console.error('Failed to fetch Japan data:', error); }
        }

        function populateRegionFilter(regions) {
            const regionFilter = document.getElementById('region-filter');
            if(!regionFilter) return;
            const currentVal = regionFilter.value;
            regionFilter.innerHTML = '<option value="all">ã™ã¹ã¦ã®åœ°åŸŸ</option>';
            const sortedRegions = Array.from(regions).sort();
            sortedRegions.forEach(region => { const option = document.createElement('option'); option.value = region; option.textContent = region; regionFilter.appendChild(option); });
            regionFilter.value = currentVal;
        }
        
        // --- Modal and UI Logic ---
        function showModal(title, content, modalId = `modal-${Date.now()}`) {
            // For general modals, remove existing with same ID or create new
            const existingModal = document.getElementById(modalId);
            if(existingModal) existingModal.remove();

            const modalEl = document.createElement('div');
            modalEl.id = modalId;
            modalEl.className = 'modal-overlay';
            modalEl.innerHTML = `
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 class="text-xl font-bold">${title}</h2>
                    </div>
                    <div class="modal-body">${content}</div>
                    <div class="modal-footer">
                        <button class="modal-close bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">é–‰ã˜ã‚‹</button>
                    </div>
                </div>`;
            modalContainer.appendChild(modalEl);
            
            setTimeout(() => modalEl.classList.add('visible'), 10);

            const close = () => {
                modalEl.classList.remove('visible');
                setTimeout(() => modalEl.remove(), 300);
            };
            
            modalEl.querySelector('.modal-close').addEventListener('click', close);
            modalEl.addEventListener('click', (e) => { if (e.target === modalEl) close(); });
            return modalEl;
        }

        function showDroneNarrativeModal() {
            if (!lastDroneNarrative) {
                showModal('æƒ…å ±ãªã—', '<p>è¡¨ç¤ºã™ã‚‹ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšæ–°ã—ã„ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>');
                return;
            }

            // ONLY display static path if NO animation is currently running
            // If an animation is running, the droneLayer already contains the animated drone and route.
            if (!droneAnimationId && lastDroneMission) { // Check if animation is NOT active AND static mission data exists
                displayStaticDronePath(lastDroneMission.start, lastDroneMission.end);
            } else if (!droneAnimationId && !lastDroneMission) {
                // No animation running, but no last mission data either. Clear layer just in case.
                droneLayer.clearLayers();
            }


            // Reuse the pre-existing drone-narrative-modal element
            const modalEl = droneNarrativeModalEl;
            modalEl.querySelector('.modal-body').innerHTML = lastDroneNarrative;
            
            // Show the modal
            modalEl.classList.add('visible');
            modalEl.classList.remove('hidden'); // Ensure it's not hidden by display:none

            // Attach close listener if not already attached (or re-attach for safety)
            const closeButton = modalEl.querySelector('.modal-close');
            const closeHandler = () => {
                modalEl.classList.remove('visible');
                // Use 'hidden' class to truly hide it, not remove from DOM
                setTimeout(() => modalEl.classList.add('hidden'), 300); 
                // If animation is NOT running, clear the static path when modal is closed
                if (!droneAnimationId) {
                    droneLayer.clearLayers();
                }
            };
            closeButton.onclick = null; // Clear previous listeners
            closeButton.addEventListener('click', closeHandler);
            modalEl.onclick = (e) => { // Close when clicking outside
                if (e.target === modalEl) closeHandler();
            };
        }


        function updateModalContent(content, modalEl) {
            const target = modalEl ? modalEl.querySelector('.modal-body') : modalContainer.querySelector('.modal-overlay:last-child .modal-body');
            if(target) target.innerHTML = content;
        }

        function showAiToolsModal() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-bold mb-2">å…¨ä½“çŠ¶æ³ã®åˆ†æ</h3>
                        <p class="text-sm mb-2 text-gray-600">ç¾åœ¨ã®åœ°éœ‡æ´»å‹•å…¨ä½“ã®å‚¾å‘ã‚’AIãŒåˆ†æã—ã€ä»Šå¾Œã®è¦‹é€šã—ã‚„æ³¨æ„ç‚¹ã‚’å ±å‘Šã—ã¾ã™ã€‚</p>
                        <button id="analysis-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">æ´»å‹•çŠ¶æ³ã®AIåˆ†æã‚’é–‹å§‹</button>
                    </div>
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-bold mb-2">MYé˜²ç½ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                        <p class="text-sm mb-2 text-gray-600">ã‚ãªãŸã®å ´æ‰€ã¨ä¸–å¸¯æ§‹æˆã«åˆã‚ã›ãŸã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãªé˜²ç½è¨ˆç”»ã‚’AIãŒä½œæˆã—ã¾ã™ã€‚</p>
                        <div class="space-y-2">
                            <input type="text" id="location-input" placeholder="å ´æ‰€ã‚’å…¥åŠ› or åœ°å›³ã§æŒ‡å®š" class="w-full p-2 border rounded-md">
                            <div class="flex gap-2">
                                <button id="map-select-button" class="flex-1 bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300 text-sm">åœ°å›³ã‹ã‚‰é¸æŠ</button>
                                <button id="gps-button" class="flex-1 bg-gray-200 py-2 px-4 rounded-md hover:bg-gray-300 text-sm">ç¾åœ¨åœ°ã‚’å–å¾—</button>
                            </div>
                            <select id="household-type" class="w-full p-2 border rounded-md">
                                <option>ä¸€äººæš®ã‚‰ã—</option>
                                <option>äºŒäººæš®ã‚‰ã—</option>
                                <option>å­ã©ã‚‚ãŒã„ã‚‹å®¶åº­</option>
                                <option>é«˜é½¢è€…ãŒã„ã‚‹å®¶åº­</option>
                            </select>
                            <button id="safety-report-button" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">MYé˜²ç½ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ</button>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-bold mb-2">ãã®ä»–ã®AIé˜²ç½ãƒ„ãƒ¼ãƒ«</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <button id="prepare-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">äº‹å‰ã®å‚™ãˆ</button>
                            <button id="power-outage-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">åœé›»ãƒªã‚¹ã‚¯åˆ†æ</button>
                            <button id="transit-advice-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">äº¤é€šæ©Ÿé–¢ã‚¢ãƒ‰ãƒã‚¤ã‚¹</button>
                            <button id="drone-future-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">ãƒ‰ãƒ­ãƒ¼ãƒ³ã®æœªæ¥</button>
                        </div>
                    </div>
                </div>
            `;
            const modalEl = showModal('ğŸ¤– AIé˜²ç½ãƒ„ãƒ¼ãƒ«', content);
            const locationInput = modalEl.querySelector('#location-input');
            if (userAddress) {
                locationInput.value = userAddress;
            }
        }

        function showFilterModal() {
            const worldFilterDisplay = currentMode === 'world' ? 'block' : 'none';
            const content = `
                <div class="space-y-4">
                    <div>
                        <label for="mag-filter" class="block mb-2 font-bold">æœ€å°ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰: <span id="mag-value">0</span></label>
                        <input type="range" id="mag-filter" min="0" max="9" step="0.5" value="${document.getElementById('mag-filter')?.value || 0}" class="w-full">
                    </div>
                    <div id="world-filter-container" style="display: ${worldFilterDisplay};">
                        <label for="region-filter" class="block mb-2 font-bold">åœ°åŸŸ</label>
                        <select id="region-filter" class="w-full p-2 border rounded-md">
                            ${document.getElementById('region-filter')?.innerHTML || '<option value="all">ã™ã¹ã¦ã®åœ°åŸŸ</option>'}
                        </select>
                    </div>
                    <div class="text-right">
                        <button id="apply-filter-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">é©ç”¨</button>
                    </div>
                </div>
            `;
            const modalEl = showModal('çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼', content);
            const magFilter = modalEl.querySelector('#mag-filter');
            const magValue = modalEl.querySelector('#mag-value');
            magValue.textContent = magFilter.value;
            magFilter.addEventListener('input', () => magValue.textContent = magFilter.value);
        }

        function showInfoShareModal() {
            const content = `
                <p class="mb-4">åœ°å›³ä¸Šã«è¿½åŠ ã—ãŸã„æƒ…å ±ã®ç¨®é¡ã‚’é¸æŠã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="space-y-3">
                    <div>
                        <label for="note-type" class="block text-sm font-medium text-gray-700">æƒ…å ±ã®ç¨®é¡</label>
                        <select id="note-type" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="danger">å±é™ºç®‡æ‰€ âš ï¸</option>
                            <option value="support">æ”¯æ´æ‹ ç‚¹ ğŸ¤</option>
                            <option value="supply">ç‰©è³‡æƒ…å ± ğŸ“¦</option>
                        </select>
                    </div>
                    <div>
                        <label for="note-comment" class="block text-sm font-medium text-gray-700">ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                        <input type="text" id="note-comment" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹ï¼šã“ã®å…ˆã®æ©‹ãŒé€šè¡Œæ­¢ã‚ã§ã™">
                    </div>
                    <div class="text-right pt-2">
                        <button id="submit-note-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">åœ°å›³ä¸Šã§å ´æ‰€ã‚’æŒ‡å®š</button>
                    </div>
                </div>
            `;
            showModal('å…±æœ‰æƒ…å ±ã‚’è¿½åŠ ', content);
        }
        
        // --- Utility Functions ---
        function formatTextToHtml(text) {
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/### (.*$)/gm, '<h4>$1</h4>')
                .replace(/## (.*$)/gm, '<h3>$1</h3>')
                .replace(/# (.*$)/gm, '<h2>$1</h2>')
                .replace(/^\* (.*$)/gm, '<li>$1</li>');
            html = html.replace(/<li>/g, '<ul><li>').replace(/<\/li>/g, '</li></ul>');
            html = html.replace(/<\/ul>\s*<ul>/g, '');
            return html.replace(/\n/g, '<br>').replace(/<br><br>/g, '<br>');
        }
        function setApiButtonsState(inProgress) {
            isApiCallInProgress = inProgress;
            document.querySelectorAll('#toolbox button, .modal-container button').forEach(button => button.disabled = inProgress);
        }
        function getMagnitudeColor(mag) { if (mag >= 7) return '#b30000'; if (mag >= 6) return '#d73027'; if (mag >= 5) return '#fc8d59'; if (mag >= 4) return '#fee08b'; return '#91cf60'; }
        function getJmaShindoColor(shindo) { const map = { '7':'#580b27', '6å¼·':'#b30000', '6å¼±':'#d73027', '5å¼·':'#fc8d59', '5å¼±':'#fee08b', '4':'#ffffbf', '3':'#d9ef8b', '2':'#91cf60', '1':'#1a9850', '0':'#cccccc' }; return map[shindo] || '#cccccc'; }
        function convertMmiToRoman(mmi) { if (mmi == null || mmi < 1) return 'æƒ…å ±ãªã—'; const map = {1:'I', 2:'II', 3:'III', 4:'IV', 5:'V', 6:'VI', 7:'VII', 8:'VIII', 9:'IX'}; const roundedMmi = Math.round(mmi); if (roundedMmi >= 10) return 'X+'; return map[roundedMmi] || 'æƒ…å ±ãªã—'; }
        function convertMmiToJmaShindo(mmi) { if (mmi == null || mmi < 0) return 'æƒ…å ±ãªã—'; if (mmi < 0.5) return '0'; if (mmi < 1.5) return '1'; if (mmi < 2.5) return '2'; if (mmi < 3.5) return '3'; if (mmi < 4.5) return '4'; if (mmi < 5.0) return '5å¼±'; if (mmi < 5.5) return '5å¼·'; if (mmi < 6.0) return '6å¼±'; if (mmi < 6.5) return '6å¼·'; return '7'; }
        function convertScale(scale) { const scaleMap = { 10:'1', 20:'2', 30:'3', 40:'4', 45:'5å¼±', 50:'5å¼·', 55:'6å¼±', 60:'6å¼·', 70:'7' }; return scaleMap[scale] ?? 'ä¸æ˜'; }
        function isDarkColor(hexcolor) { if (!hexcolor || !hexcolor.startsWith('#')) return false; const r = parseInt(hexcolor.substr(1, 2), 16), g = parseInt(hexcolor.substr(3, 2), 16), b = parseInt(hexcolor.substr(5, 2), 16); return ((r * 299) + (g * 587) + (b * 114)) / 1000 < 128; }
        function updateModeToggleButton() {
            const button = document.getElementById('mode-toggle-button');
            if (currentMode === 'japan') {
                button.title = 'ä¸–ç•Œãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿';
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>`;
            } else {
                button.title = 'æ—¥æœ¬ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿';
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.5-11.494l-2.024.953a.875.875 0 01-1.006 0l-2.83-1.331a.875.875 0 00-1.006 0l-2.909 1.365a.875.875 0 00-.527.824V18.25a.75.75 0 00.75.75h10.5a.75.75 0 00.75-.75V8.574a.875.875 0 00-.527-.824l-2.91-1.365a.875.875 0 00-1.005 0l-2.83 1.331a.875.875 0 01-1.006 0l-2.024-.953" /></svg>`;
            }
        }

        // --- Location Picker Logic ---
        function enterPinMode(targetInputId = 'location-input') {
            L.DomUtil.addClass(map.getContainer(), 'map-pin-mode');
            const instructionModal = showModal('å ´æ‰€ã‚’é¸æŠ', '<p>åœ°å›³ä¸Šã®ç›®çš„ã®åœ°ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>');
            map.once('click', (e) => {
                onMapClick(e, targetInputId);
                instructionModal.querySelector('.modal-close').click();
            });
        }
        function enterPinDropMode() {
            L.DomUtil.addClass(map.getContainer(), 'map-pin-mode');
            map.once('click', (e) => {
                L.DomUtil.removeClass(map.getContainer(), 'map-pin-mode');
                handlePinDrop(e);
            });
        }
        async function updatePinAddress(marker, defaultText = "ä½æ‰€ã‚’æ¤œç´¢ä¸­...") {
            const { lat, lng } = marker.getLatLng();
            userCoords = { lat, lng };
            marker.bindPopup(defaultText).openPopup();
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja`);
                if(!response.ok) throw new Error("Network response was not ok.");
                const data = await response.json();
                let displayAddress = 'ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
                if (data && data.address) {
                    const address = data.address;
                    displayAddress = `${address.country || ''} ${address.state || ''} ${address.city || address.town || address.village || ''} ${address.road || ''} ${address.house_number || ''}`.trim();
                }
                userAddress = displayAddress;
                marker.getPopup().setContent(`<strong>æŒ‡å®šã—ãŸå ´æ‰€:</strong><br>${displayAddress}`);
            } catch (error) {
                console.error("Reverse geocoding failed:", error);
                userAddress = 'ä½æ‰€ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
                marker.getPopup().setContent(userAddress);
            }
        }
        function handlePinDrop(e) {
            const { lat, lng } = e.latlng;
            if (locationMarker) { map.removeLayer(locationMarker); }
            const pinIcon = L.divIcon({className: 'text-4xl', html: 'ğŸ“'});
            locationMarker = L.marker([lat, lng], {
                icon: pinIcon,
                draggable: true // Make the pin draggable
            }).addTo(map);
            
            locationMarker.on('dragend', function(event) {
                updatePinAddress(event.target);
            });
            updatePinAddress(locationMarker);
        }
        async function onMapClick(e, targetInputId = 'location-input') {
            const { lat, lng } = e.latlng;
            userCoords = { lat, lng };
            L.DomUtil.removeClass(map.getContainer(), 'map-pin-mode');
            const locationInput = document.getElementById(targetInputId);
            if (!locationInput) return;
            locationInput.value = 'åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’æ¤œç´¢ä¸­...';
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja`);
                if(!response.ok) throw new Error("Network response was not ok.");
                const data = await response.json();
                if (data && data.address) {
                    const address = data.address;
                    const displayAddress = `${address.country || ''} ${address.state || ''} ${address.city || address.town || address.village || ''}`.trim();
                    userAddress = displayAddress;
                    locationInput.value = displayAddress || 'ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else {
                    userAddress = 'ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
                    locationInput.value = userAddress;
                }
            } catch (error) {
                console.error("Reverse geocoding failed:", error);
                userAddress = 'ä½æ‰€ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
                locationInput.value = userAddress;
            }
        }
        function getCurrentLocation(targetInputId = 'location-input') {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => onMapClick({ latlng: { lat: position.coords.latitude, lng: position.coords.longitude } }, targetInputId),
                    (error) => showModal('GPSã‚¨ãƒ©ãƒ¼', `<p>GPSæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</p>`)
                );
            } else {
                showModal('GPSã‚¨ãƒ©ãƒ¼', '<p>ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯GPSæ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚</p>');
            }
        }
        
        // --- Drone Animation Logic ---
        function initializeDroneMap(mapInstance, start, end, durationMinutes, missionLog) {
            // Clear previous drone elements
            droneLayer.clearLayers();
            droneMarkers = [];
            if (droneAnimationId) cancelAnimationFrame(droneAnimationId);

            const startCoords = L.latLng(start[0], start[1]);
            const endCoords = L.latLng(end[0], end[1]);

            const destinationIcon = L.divIcon({className: 'text-4xl', html: 'ğŸ '});
            const droneBaseIcon = L.divIcon({className: 'text-4xl', html: 'ğŸ“¡'});
            const droneIcon = L.divIcon({className: 'text-4xl drone-icon', html: 'ğŸš'});

            const destMarker = L.marker(endCoords, {icon: destinationIcon}).addTo(droneLayer).bindTooltip("ç›®çš„åœ°");
            const baseMarker = L.marker(startCoords, {icon: droneBaseIcon}).addTo(droneLayer).bindTooltip("ãƒ‰ãƒ­ãƒ¼ãƒ³åŸºåœ°");
            
            const route = L.polyline([startCoords, endCoords], {color: 'blue', dashArray: '5, 10'}).addTo(droneLayer);
            const movingDrone = L.marker(startCoords, {icon: droneIcon}).addTo(droneLayer);

            droneMarkers.push(destMarker, baseMarker, route, movingDrone); // Keep track for clearing

            mapInstance.fitBounds(L.featureGroup([destMarker, baseMarker]).getBounds().pad(0.2)); // Fit bounds to start and end points

            // Show drone dashboard
            droneDashboard.classList.remove('hidden');
            // Clear mission log
            const missionLogEl = document.getElementById('mission-log');
            if (missionLogEl) missionLogEl.innerHTML = '';

            // Reset drone state for new animation
            currentDroneState = {
                speed: 0,
                altitude: 0,
                battery: 100,
                windSpeed: 0,
                obstacleDetected: false,
                targetSpeed: 50, // km/h
                targetAltitude: 100, // meters
                targetWindSpeed: 5 // m/s
            };

            animateDrone(movingDrone, route, durationMinutes * 60 * 1000, missionLog);
        }

        // New function to display static drone path
        function displayStaticDronePath(start, end) {
            droneLayer.clearLayers(); // Clear any existing drone elements

            const startCoords = L.latLng(start[0], start[1]);
            const endCoords = L.latLng(end[0], end[1]);

            const destinationIcon = L.divIcon({className: 'text-4xl', html: 'ğŸ '});
            const droneBaseIcon = L.divIcon({className: 'text-4xl', html: 'ğŸ“¡'});

            L.marker(endCoords, {icon: destinationIcon}).addTo(droneLayer).bindTooltip("ç›®çš„åœ°");
            L.marker(startCoords, {icon: droneBaseIcon}).addTo(droneLayer).bindTooltip("ãƒ‰ãƒ­ãƒ¼ãƒ³åŸºåœ°");
            
            L.polyline([startCoords, endCoords], {color: 'blue', dashArray: '5, 10'}).addTo(droneLayer);

            map.fitBounds(L.featureGroup([L.marker(startCoords), L.marker(endCoords)]).getBounds().pad(0.2)); // Fit bounds
        }
        
        function animateDrone(marker, route, duration, missionLog) {
            if (droneAnimationId) cancelAnimationFrame(droneAnimationId);
            let start = null;
            const latlngs = route.getLatLngs();
            const missionLogEl = document.getElementById('mission-log');
            const speedEl = document.getElementById('drone-speed');
            const altitudeEl = document.getElementById('drone-altitude');
            const batteryEl = document.getElementById('drone-battery');
            const windSpeedEl = document.getElementById('drone-wind-speed');
            const obstacleDetectionEl = document.getElementById('drone-obstacle-detection');
            const etaEl = document.getElementById('drone-eta');

            let currentLogIndex = 0;
            let lastUpdateTimestamp = 0;
            const updateInterval = 500; // Update every 500ms for smoother values

            function animationStep(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                const ratio = Math.min(progress / duration, 1);

                // Update mission log
                if (missionLogEl && (currentLogIndex < missionLog.length) && (missionLog[currentLogIndex].time * 60 * 1000) <= progress) {
                    const logEntry = document.createElement('p');
                    logEntry.textContent = `[${new Date(Date.now() + progress).toLocaleTimeString()}] ${missionLog[currentLogIndex].event}`;
                    missionLogEl.appendChild(logEntry);
                    missionLogEl.scrollTop = missionLogEl.scrollHeight;
                    currentLogIndex++;
                }

                // Update real-time info more realistically
                if (timestamp - lastUpdateTimestamp > updateInterval) {
                    // Speed: gradually approach target, with small fluctuations
                    const speedChange = (currentDroneState.targetSpeed - currentDroneState.speed) * 0.1 + (Math.random() - 0.5) * 1; // +/- 0.5 km/h
                    currentDroneState.speed = Math.max(0, Math.min(currentDroneState.targetSpeed * 1.1, currentDroneState.speed + speedChange));
                    if(speedEl) speedEl.textContent = `${currentDroneState.speed.toFixed(1)}`;

                    // Altitude: gradually approach target, with small fluctuations
                    const altitudeChange = (currentDroneState.targetAltitude - currentDroneState.altitude) * 0.1 + (Math.random() - 0.5) * 0.5; // +/- 0.25 m
                    currentDroneState.altitude = Math.max(0, Math.min(currentDroneState.targetAltitude * 1.1, currentDroneState.altitude + altitudeChange));
                    if(altitudeEl) altitudeEl.textContent = `${currentDroneState.altitude.toFixed(1)}`;

                    // Battery: mostly linear, with minor random drain
                    currentDroneState.battery = Math.max(0, currentDroneState.battery - (0.01 + Math.random() * 0.02)); // Drain 0.01-0.03% per update
                    if(batteryEl) batteryEl.textContent = `${currentDroneState.battery.toFixed(1)}`;

                    // Wind Speed: gradual random fluctuations
                    const windChange = (Math.random() - 0.5) * 0.2; // +/- 0.1 m/s
                    currentDroneState.windSpeed = Math.max(0, Math.min(currentDroneState.targetWindSpeed * 1.2, currentDroneState.windSpeed + windChange));
                    if(windSpeedEl) windSpeedEl.textContent = `${currentDroneState.windSpeed.toFixed(1)}`;

                    // Obstacle Detection: low probability, but can "stick" for a bit
                    if (Math.random() < 0.005) { // 0.5% chance per update
                        currentDroneState.obstacleDetected = true;
                        if(obstacleDetectionEl) obstacleDetectionEl.textContent = 'æ¤œçŸ¥ï¼';
                    } else if (currentDroneState.obstacleDetected && Math.random() < 0.1) { // 10% chance to clear if detected
                        currentDroneState.obstacleDetected = false;
                        if(obstacleDetectionEl) obstacleDetectionEl.textContent = 'ãªã—';
                    } else if (!currentDroneState.obstacleDetected) {
                        if(obstacleDetectionEl) obstacleDetectionEl.textContent = 'ãªã—';
                    }

                    lastUpdateTimestamp = timestamp;
                }

                const remainingMinutes = (duration - progress) / 1000 / 60;
                if(etaEl) etaEl.textContent = `${Math.max(0, remainingMinutes).toFixed(1)} åˆ†`;

                if (ratio < 1) {
                    const newLatLng = L.latLng(
                        latlngs[0].lat + ratio * (latlngs[1].lat - latlngs[0].lat),
                        latlngs[0].lng + ratio * (latlngs[1].lng - latlngs[0].lng)
                    );
                    marker.setLatLng(newLatLng);
                    droneAnimationId = requestAnimationFrame(animationStep);
                } else {
                    marker.setLatLng(latlngs[1]);
                    marker.setIcon(L.divIcon({className: 'text-4xl', html: 'âœ…'}));
                    if(etaEl) etaEl.textContent = 'åˆ°ç€æ¸ˆã¿';
                    // Hide dashboard and clear drone elements after completion
                    setTimeout(() => {
                        droneDashboard.classList.add('hidden');
                        // Only clear droneLayer if no narrative modal is open and showing static path
                        // Or, more simply, just clear it after animation completes.
                        // The static path logic in showDroneNarrativeModal will redraw it if needed.
                        droneLayer.clearLayers();
                        droneMarkers = [];
                    }, 3000); // Hide after 3 seconds
                }
            }
            droneAnimationId = requestAnimationFrame(animationStep);
        }

        function cancelDroneMission() {
            if (droneAnimationId) {
                cancelAnimationFrame(droneAnimationId);
                droneAnimationId = null;
            }
            droneLayer.clearLayers();
            droneMarkers = [];
            droneDashboard.classList.add('hidden');
            showModal('ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«', '<p>ãƒ‰ãƒ­ãƒ¼ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚</p>');
        }

        // --- Event Listeners ---
        document.getElementById('mode-toggle-button').addEventListener('click', () => {
            switchMode(currentMode === 'japan' ? 'world' : 'japan');
        });
        document.getElementById('filter-button').addEventListener('click', showFilterModal);
        document.getElementById('ai-tools-button').addEventListener('click', showAiToolsModal);
        document.getElementById('info-share-button').addEventListener('click', showInfoShareModal);
        document.getElementById('drone-request-button').addEventListener('click', handleDroneRequest);
        document.getElementById('cancel-drone-mission').addEventListener('click', cancelDroneMission);
        
        // Event listener for showing drone narrative
        showDroneNarrativeButton.addEventListener('click', showDroneNarrativeModal);


        // Delegated event listener for buttons inside modals
        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if(!target || !target.id) return;
            
            switch(target.id) {
                case 'analysis-button': generateAnalysis(); break;
                case 'prepare-button': generatePreparednessTips(); break;
                case 'safety-report-button': {
                    const locationInput = document.getElementById('location-input');
                    const householdType = document.getElementById('household-type');
                    generateSafetyReport(locationInput?.value, householdType?.value); 
                    break;
                }
                case 'map-select-button': enterPinMode('location-input'); break;
                case 'gps-button': getCurrentLocation('location-input'); break;
                case 'power-outage-button': generatePowerOutageReport(); break;
                case 'drone-future-button': generateDroneFutureReport(); break;
                case 'transit-advice-button': generateTransitAdvice(); break;
                case 'apply-filter-button': {
                    applyFilters();
                    target.closest('.modal-overlay')?.querySelector('.modal-close').click();
                    break;
                }
                case 'submit-note-button': {
                    const formModal = target.closest('.modal-overlay');
                    const type = formModal.querySelector('#note-type').value;
                    const commentInput = formModal.querySelector('#note-comment');
                    const comment = commentInput.value;
                    if (!comment) {
                        commentInput.placeholder = "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
                        commentInput.classList.add('border-red-500');
                        return;
                    }
                    const icons = { danger: 'âš ï¸', support: 'ğŸ¤', supply: 'ğŸ“¦' };

                    formModal.querySelector('.modal-close').click();
                    const instructionModal = showModal('æƒ…å ±è¿½åŠ ', '<p>åœ°å›³ä¸Šã®æƒ…å ±ã‚’è¿½åŠ ã—ãŸã„åœ°ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>');
                    
                    map.once('click', (mapClickEvent) => {
                        L.marker(mapClickEvent.latlng, { icon: L.divIcon({className: 'text-2xl', html: icons[type]}) })
                            .addTo(notesLayer)
                            .bindPopup(`<strong>${type}</strong><br>${comment}`);
                        instructionModal.querySelector('.modal-close').click();
                    });
                    break;
                }
            }
        });

        // --- Initial Load ---
        switchMode('japan');
        fetchTectonicPlates();
    });
    </script>
</body>
</html>

